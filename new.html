<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI-Driven Multi-Cloud Optimization Engine V6 (Interactive)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        :root {
            --var-text-color: #e0f2fe; /* Light Blue */
            --var-accent-color: #00ffff; /* Bright Cyan/Aqua */
            --var-card-color: #1a202c; /* Dark Slate Gray */
            --var-bg-color: #0a0e14; /* Deep Dark Blue/Black */
            --var-error-color: #f87171; /* Bright Red */
            --var-success-color: #34d399; /* Emerald Green */
            --var-warning-color: #facc15; /* Yellow */
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--var-bg-color);
            color: var(--var-text-color);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 1rem;
        }
        .app-container {
            position: relative;
            z-index: 10;
        }
        /* Neon Focus Effect */
        .neon-border {
            border: 1px solid #4a5568;
            transition: all 0.3s ease;
        }
        .neon-border:focus {
            border-color: var(--var-accent-color);
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.6), 0 0 5px rgba(0, 255, 255, 0.4) inset;
            outline: none;
        }
        /* Primary Button */
        .btn-primary {
            background: linear-gradient(90deg, #00ffff, #00bfff);
            color: #0a0e14;
            font-weight: 700;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 255, 255, 0.4);
            letter-spacing: 0.05em;
        }
        .btn-primary:hover:not(:disabled) {
            opacity: 0.9;
            box-shadow: 0 6px 20px rgba(0, 255, 255, 0.6);
            transform: translateY(-1px);
        }
        .btn-primary:disabled {
            background: #4a5568;
            cursor: not-allowed;
            box-shadow: none;
        }
        .error-box {
            background-color: rgba(248, 113, 113, 0.1);
            border: 1px solid var(--var-error-color);
            color: var(--var-error-color);
            padding: 1rem;
            border-radius: 0.75rem;
            margin-bottom: 1.5rem;
            font-weight: 600;
        }
        .result-card {
            background-color: var(--var-card-color);
            padding: 1rem;
            border-radius: 0.75rem;
            border: 1px solid #2d3748;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        }

        /* --- New: Loading and Result Animations --- */
        #loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(10, 14, 20, 0.95); /* Deeper opacity */
            z-index: 50;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            border-radius: 1rem;
            color: var(--var-accent-color);
            font-size: 1.25rem;
            font-weight: 600;
            animation: fadeIn 0.5s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        /* Spinner */
        .spinner {
            border: 4px solid rgba(0, 255, 255, 0.2);
            border-top: 4px solid var(--var-accent-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Card Pulse (Active AI selection) */
        @keyframes neonPulse {
            0%, 100% { box-shadow: 0 0 5px var(--var-accent-color); }
            50% { box-shadow: 0 0 20px var(--var-accent-color); }
        }
        .pulse-active {
            animation: neonPulse 1.5s ease-in-out infinite;
        }
        /* Result Section Slide Up */
        .slide-up-active {
            animation: slideUp 0.8s ease-out forwards;
            transform: translateY(20px);
            opacity: 0;
        }
        @keyframes slideUp {
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
    </style>
</head>

<body class="p-4 sm:p-8">
    <div id="app" class="app-container w-full max-w-6xl bg-gray-900/50 p-6 sm:p-10 rounded-2xl shadow-2xl border border-gray-700">

        <div id="loading-overlay" class="hidden">
            <div class="spinner"></div>
            <p id="loading-message">Analyzing 4 Dimensions: Cost, Performance, Compliance, Carbon...</p>
        </div>

        <header class="mb-8 border-b border-gray-700 pb-4">
            <h1 class="text-3xl sm:text-4xl font-extrabold flex items-center text-white">
                <span class="text-4xl mr-3" style="color: var(--var-accent-color);">üß†</span>
                AI-Driven Multi-Cloud Optimization Engine
            </h1>
            <p class="text-gray-400 mt-2 text-sm">Predictive policy generation for **cost, performance, and sustainability** using highly transparent XAI logic.</p>
        </header>

        <section id="input-section" class="mb-10">
            <h2 class="text-xl font-semibold mb-4 text-gray-200">Workload Profile & Policy</h2>
            <div id="validation-error" class="error-box hidden" style="border-color: var(--var-error-color); color: var(--var-error-color);"></div>

            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                <div>
                    <label for="dataVolume" class="block text-xs font-medium mb-1 text-gray-300">Data Volume (TB)</label>
                    <input type="number" id="dataVolume" value="500" min="1" class="w-full p-3 rounded-lg bg-gray-800 text-white neon-border" placeholder="e.g., 500">
                </div>
                <div>
                    <label for="accessFrequency" class="block text-xs font-medium mb-1 text-gray-300">Access Frequency (Reads/Mo, Millions)</label>
                    <input type="number" id="accessFrequency" value="5" min="0" class="w-full p-3 rounded-lg bg-gray-800 text-white neon-border" placeholder="e.g., 5">
                </div>
                 <div>
                    <label for="maxBudget" class="block text-xs font-medium mb-1 text-gray-300">Max Monthly Budget ($)</label>
                    <input type="number" id="maxBudget" value="8000" min="1" class="w-full p-3 rounded-lg bg-gray-800 text-white neon-border" placeholder="e.g., 8000">
                </div>
                <div>
                    <label for="forecastHorizon" class="block text-xs font-medium mb-1 text-gray-300">Forecasting Horizon (Months)</label>
                    <input type="number" id="forecastHorizon" value="24" min="1" class="w-full p-3 rounded-lg bg-gray-800 text-white neon-border" placeholder="e.g., 24">
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 items-start mb-6 border p-4 rounded-xl border-gray-800 bg-gray-900/40">
                <div>
                    <label for="compliancePolicy" class="block text-xs font-medium mb-1 text-gray-300">Compliance/Regulatory Mandate</label>
                    <input type="text" id="compliancePolicy" value="GDPR" class="w-full p-3 rounded-lg bg-gray-800 text-white neon-border" placeholder="e.g., GDPR, HIPAA">
                </div>
                <div>
                    <label for="rtoConstraint" class="block text-xs font-medium mb-1 text-gray-300">Max Acceptable Retrieval Time (seconds)</label>
                    <input type="number" id="rtoConstraint" value="5" min="0.1" class="w-full p-3 rounded-lg bg-gray-800 text-white neon-border" placeholder="e.g., 5">
                    <p class="text-xs text-gray-500 mt-1">Archive tiers often fail if this is too low.</p>
                </div>
                <div>
                    <label for="egressMultiplier" class="block text-xs font-medium mb-1 text-gray-300">Simulated Egress Cost Multiplier</label>
                    <input type="range" id="egressMultiplier" value="1" min="0.5" max="3" step="0.5" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer range-lg">
                    <p class="text-xs text-gray-500 mt-1">Current Multiplier: <span id="egressMultiplierDisplay" class="text-cyan-400">1.0x</span> (Simulates high data transfer out fees)</p>
                </div>
            </div>

            <h2 class="text-xl font-semibold mb-3 mt-8 text-gray-200 flex items-center"><span class="text-3xl mr-2" style="color: var(--var-accent-color);">‚öñÔ∏è</span> AI Optimization Priority Weights (Must sum to 100%)</h2>
            
            <div class="grid grid-cols-1 sm:grid-cols-4 gap-6 mb-6 p-4 bg-gray-800 rounded-xl border border-gray-700" id="weight-sliders">
                <div class="space-y-2">
                    <label for="weightCost" class="block text-sm font-medium text-cyan-400">Cost Priority: <span id="costValue">40</span>%</label>
                    <input type="range" id="weightCost" value="40" min="5" max="95" step="5" class="w-full h-2 bg-cyan-700 rounded-lg appearance-none cursor-pointer">
                </div>
                <div class="space-y-2">
                    <label for="weightPerformance" class="block text-sm font-medium text-green-400">Performance Priority: <span id="performanceValue">25</span>%</label>
                    <input type="range" id="weightPerformance" value="25" min="5" max="95" step="5" class="w-full h-2 bg-green-700 rounded-lg appearance-none cursor-pointer">
                </div>
                <div class="space-y-2">
                    <label for="weightCarbon" class="block text-sm font-medium text-yellow-400">Carbon Priority: <span id="carbonValue">15</span>%</label>
                    <input type="range" id="weightCarbon" value="15" min="5" max="95" step="5" class="w-full h-2 bg-yellow-700 rounded-lg appearance-none cursor-pointer">
                </div>
                <div class="space-y-2">
                    <label for="weightCompliance" class="block text-sm font-medium text-red-400">Compliance Priority: <span id="complianceValue">20</span>%</label>
                    <input type="range" id="weightCompliance" value="20" min="5" max="95" step="5" class="w-full h-2 bg-red-700 rounded-lg appearance-none cursor-pointer">
                </div>
            </div>
            
            <div class="flex flex-col sm:flex-row justify-between items-center mt-6 p-4 bg-gray-800 rounded-xl border border-gray-700">
                 <label for="anomalyDetection" class="flex items-center space-x-2 text-sm font-medium text-gray-200">
                        <input type="checkbox" id="anomalyDetection" class="h-4 w-4 text-cyan-500 rounded border-gray-600 focus:ring-cyan-500" checked>
                        <span>Proactive Anomaly Detection (Simulate access spike, shift to warmer tier)</span>
                 </label>
                 <button id="runOptimization" class="btn-primary flex items-center justify-center text-lg mt-4 sm:mt-0 w-full sm:w-auto px-10">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                    Run AI Optimization
                </button>
            </div>
        </section>

        <section id="result-section" class="hidden mt-10">
            <h2 class="text-2xl font-bold mb-4 flex items-center" style="color: var(--var-success-color);">
                <span class="text-3xl mr-2">ü§ñ</span> FINAL OPTIMIZATION POLICY
            </h2>

            <div id="anomaly-alert" class="error-box hidden" style="border-color: var(--var-warning-color); color: var(--var-warning-color);" role="alert"></div>
            <div id="budget-warning" class="error-box hidden" role="alert"></div>

            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8 text-center">
                <div id="card-provider" class="result-card pulse-active">
                    <p class="text-xs sm:text-sm font-medium opacity-75 mb-2">Optimal Provider/Tier</p>
                    <p id="optimal-provider" class="text-xl sm:text-2xl font-extrabold" style="color: var(--var-accent-color);"></p>
                </div>
                <div id="card-savings" class="result-card pulse-active">
                    <p class="text-xs sm:text-sm font-medium opacity-75 mb-2">Projected Monthly Savings</p>
                    <p id="projected-savings" class="text-2xl sm:text-3xl font-extrabold" style="color: var(--var-success-color);"></p>
                </div>
                <div class="result-card">
                    <p class="text-xs sm:text-sm font-medium opacity-75 mb-2">Latency Reduction (RTO Compliance)</p>
                    <p id="projected-latency" class="text-2xl sm:text-3xl font-extrabold" style="color: var(--var-success-color);"></p>
                </div>
                 <div class="result-card">
                    <p class="text-xs sm:text-sm font-medium opacity-75 mb-2">Carbon Impact Score (g/kWh)</p>
                    <p id="carbon-score" class="text-2xl sm:text-3xl font-extrabold text-white"></p>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                <div>
                    <h3 class="text-xl font-bold mb-2" style="color: var(--var-text-color);"><span style="color: var(--var-accent-color);">üîé</span> Transparency & Explainable AI (XAI)</h3>
                    <div id="xai-explanation" class="text-sm leading-relaxed text-gray-400 p-5 h-full bg-gray-800 rounded-lg border border-cyan-700/50">
                        Run the optimization loop to generate a detailed AI reasoning.
                    </div>
                </div>

                 <div>
                    <h3 class="text-xl font-bold mb-2" style="color: var(--var-text-color);"><span style="color: var(--var-accent-color);">üéØ</span> Cost/Performance Trade-off Space</h3>
                    <div class="w-full h-80 bg-gray-800 rounded-lg p-4 chart-container">
                        <canvas id="scatter-chart"></canvas>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                <div>
                    <h3 class="text-xl font-bold mb-2" style="color: var(--var-text-color);"><span style="color: var(--var-accent-color);">üìà</span> Predictive Volume Forecast (TB)</h3>
                    <div class="w-full h-80 bg-gray-800 rounded-lg p-4 chart-container">
                        <canvas id="storage-forecast-graph"></canvas>
                    </div>
                </div>
                <div>
                    <h3 class="text-xl font-bold mb-2" style="color: var(--var-text-color);"><span style="color: var(--var-accent-color);">üí∏</span> Cost Allocation Forecast (Stacked)</h3>
                    <div class="w-full h-80 bg-gray-800 rounded-lg p-4 chart-container">
                        <canvas id="cost-breakdown-chart"></canvas>
                    </div>
                </div>
            </div>

        </section>
        
        <footer class="mt-10 pt-4 border-t border-gray-800 text-center text-xs text-gray-500">
            <p>üí° **Optimization Insights:** <span id="fact-of-the-day" class="font-medium text-gray-400"></span></p>
        </footer>
    </div>

    <div id="ai-assistant-widget" class="fixed bottom-6 right-6 bg-cyan-700/80 p-3 rounded-full shadow-lg cursor-pointer hover:bg-cyan-600 transition-all">
        <span class="text-white text-lg font-bold">üí¨ AI Assistant</span>
    </div> 

    <script>
        // --- Global Chart References ---
        let forecastChart = null;
        let costChart = null;
        let scatterChart = null;

        // --- DOM Elements ---
        const runButton = document.getElementById('runOptimization');
        const resultSection = document.getElementById('result-section');
        const loadingOverlay = document.getElementById('loading-overlay');
        const loadingMessage = document.getElementById('loading-message');
        const anomalyAlert = document.getElementById('anomaly-alert');
        const budgetWarning = document.getElementById('budget-warning');
        const cardProvider = document.getElementById('card-provider');
        const cardSavings = document.getElementById('card-savings');
        const egressMultiplierInput = document.getElementById('egressMultiplier');
        const egressMultiplierDisplay = document.getElementById('egressMultiplierDisplay');
        
        // --- Global Variables for Weights (Driven by Sliders) ---
        let weights = {
            cost: 0.40,
            performance: 0.25,
            carbon: 0.15, 
            compliance: 0.20
        };

        // Hypothetical Storage Pricing Model (Realistic per TB/Month)
        // LatencyMS is the simulated retrieval time in milliseconds
        const storageTiers = [
            // Cold Tier (High latency, high retrieval cost)
            { name: "Glacier Deep Archive", provider: "AWS", storageCost: 0.99, accessCost: 10.00, egressCostFactor: 15.00, latency: "‚âà72%", latencyMS: 18000000, carbonIntensity: 450, durability: "99.999999999%" }, // 5 hours (18,000,000 ms)
            { name: "Archive Blob (LRS)", provider: "Azure", storageCost: 1.50, accessCost: 8.00, egressCostFactor: 12.00, latency: "‚âà70%", latencyMS: 10800000, carbonIntensity: 150, durability: "99.9%" }, // 3 hours
            
            // Warm Tier (Balanced)
            { name: "Cool Blob Storage", provider: "Azure", storageCost: 12.00, accessCost: 0.50, egressCostFactor: 5.00, latency: "‚âà25%", latencyMS: 1000, carbonIntensity: 150, durability: "99.9%" }, // 1 second
            { name: "Infrequent Access (IA)", provider: "AWS", storageCost: 15.00, accessCost: 0.80, egressCostFactor: 7.00, latency: "‚âà30%", latencyMS: 500, carbonIntensity: 450, durability: "99.999999999%" }, // 0.5 seconds
            { name: "Nearline Storage", provider: "GCP", storageCost: 10.00, accessCost: 1.00, egressCostFactor: 6.00, latency: "‚âà20%", latencyMS: 300, carbonIntensity: 200, durability: "99.999999999%" }, // 0.3 seconds

            // Hot Tier (Low latency, high storage cost)
            { name: "Standard Block", provider: "AWS", storageCost: 23.00, accessCost: 0.15, egressCostFactor: 0.00, latency: "‚âà5%", latencyMS: 50, carbonIntensity: 450, durability: "99.999999999%" },
            { name: "Standard Storage", provider: "GCP", storageCost: 25.00, accessCost: 0.10, egressCostFactor: 0.00, latency: "‚âà5%", latencyMS: 50, carbonIntensity: 200, durability: "99.999999999%" },
            
        ];

        // --- Core Utility Functions ---

        // Function to calculate the estimated monthly cost for a tier
        function calculateCost(tier, dataVolume, accessFrequency, egressMultiplier) {
            const totalStorageCost = tier.storageCost * dataVolume;
            const totalAccessCost = tier.accessCost * accessFrequency;
            
            // Egress Simulation: 1% of data volume is egressed monthly, scaled by user multiplier
            const egressVolume = dataVolume * 0.01; 
            const totalEgressCost = egressVolume * tier.egressCostFactor * egressMultiplier; 

            return {
                storage: totalStorageCost,
                access: totalAccessCost,
                egress: totalEgressCost,
                total: totalStorageCost + totalAccessCost + totalEgressCost
            };
        }

        // --- XAI Explanation Generator (Updated) ---
        function generateExplanation(finalTier, theoreticalTier, inputs, isBudgetExceeded, isAnomalyShift, finalScore) {
            const { dataVolume, accessFrequency, compliancePolicy, otherImplications, baselineCost, maxBudget, storageCost, accessCost, egressCost, complianceOverhead, rtoConstraint } = inputs;
            const safeDataVolume = dataVolume || 0;
            const safeAccessFrequency = accessFrequency || 0;
            const savings = ((baselineCost - finalTier.optimizedCost) / baselineCost) * 100;
            const costPerTB = (finalTier.optimizedCost / (safeDataVolume || 1)).toLocaleString('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 2 });
            const carbonGrams = finalTier.carbonIntensity * 0.005 * safeDataVolume; 
            const accessType = safeAccessFrequency > 20 ? 'HIGH' : (safeAccessFrequency > 5 ? 'MODERATE' : 'LOW');
            const latencyStatus = finalTier.latencyMS <= (rtoConstraint * 1000) ? 'met' : 'violated';

            let explanation = `<p class="font-bold text-white text-lg mb-3">‚úÖ Final Policy: ${finalTier.provider} ${finalTier.name} (Score: ${finalScore.toFixed(2)})</p>`;
            explanation += `<p>The AI Model selected this policy for your **${safeDataVolume.toLocaleString()} TB** workload, balancing all ${Object.values(weights).length} weighted factors. It forecasts a **${Math.max(0, savings).toFixed(1)}% savings** over a high-cost baseline.</p>`;
            
            // --- Decision Breakdown ---
            explanation += `<p class="mt-5 font-bold text-white text-md">Decision Breakdown (Weighted Factors):</p>`;
            explanation += `<ul class="list-disc ml-5 mt-2 space-y-3 text-gray-300">`;

            // Factor 1: Cost Efficiency
            explanation += `<li>**Cost & Budget (${(weights.cost * 100).toFixed(0)}% Influence):** The total monthly cost is **$${finalTier.optimizedCost.toLocaleString('en-US', { minimumFractionDigits: 2 })}**. 
                ${isBudgetExceeded ?
                `A **mandatory downgrade** occurred to meet the **$${maxBudget.toLocaleString()}** budget. The final choice maximizes utility within this financial constraint.` : 
                `The high cost score was achieved by optimizing for **low Egress risk** and matching storage fees to the **${accessType}** access pattern.`}</li>`;

            // Factor 2: Access & Performance
            explanation += `<li>**Performance & RTO (${(weights.performance * 100).toFixed(0)}% Influence):** The estimated retrieval time of **${finalTier.latencyMS}ms** successfully **${latencyStatus}** your RTO constraint of **${rtoConstraint} seconds**. The choice maximizes **low retrieval latency** for this ${accessType} access pattern. ${isAnomalyShift ? '**Proactive Anomaly Shift was triggered.**' : ''}</li>`;

            // Factor 3: Compliance & Constraints
            explanation += `<li>**Compliance (${(weights.compliance * 100).toFixed(0)}% Influence):** The choice of **${finalTier.provider}** meets the **${compliancePolicy}** mandate and is compliant with the additional constraint: "${otherImplications || 'None Specified'}." A $${complianceOverhead.toLocaleString('en-US', { minimumFractionDigits: 2 })} overhead was factored in.</li>`;

            // Factor 4: Carbon Footprint
            explanation += `<li>**Carbon-Aware Choice (${(weights.carbon * 100).toFixed(0)}% Influence):** The engine favored providers/regions with lower carbon intensity. **${finalTier.provider}** was preferred over alternatives with a similar cost profile due to its lower estimated $\\approx$ **${carbonGrams.toFixed(0)}g $\text{CO}_{2}$** daily impact.</li>`;
            explanation += `</ul>`;
            
            return explanation;
        }

        // --- Charting Functions ---
        let baseVolume = 0; // Global for chart data generation

        function generateChartData(horizon, initialVolume, isAnomaly, growthRate) {
             const labels = Array.from({ length: horizon + 1 }, (_, i) => `M${i}`);
             const predictedData = labels.map((_, i) => {
                let base = initialVolume + (i * growthRate);
                let noise = Math.cos(i / 6) * (initialVolume * 0.03);

                let data = base + noise;

                // Anomaly Spike (Months 10 to 15)
                if (isAnomaly && i >= 10 && i <= 15) {
                    const spikeFactor = initialVolume * 0.008;
                    data += (i - 10) * spikeFactor * 0.7;
                }
                return Math.round(data);
            });
            // Baseline data shows slower, non-optimized growth
            const baselineData = labels.map((_, i) => initialVolume + (i * (growthRate * 0.8)));
            return { labels, predictedData, baselineData };
        }

        // 1. Predictive Volume Forecast Chart
        function createForecastChart(canvasId, horizon, initialVolume, isAnomaly) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            baseVolume = initialVolume;
            const growthRate = initialVolume * 0.005 + 2; 
            const { labels, predictedData, baselineData } = generateChartData(horizon, initialVolume, isAnomaly, growthRate);
            
            const data = {
                labels: labels,
                datasets: [
                    {
                        label: 'Predicted Usage (TB) - Proactive Tiering',
                        data: predictedData,
                        borderColor: 'var(--var-accent-color)',
                        backgroundColor: 'rgba(0, 255, 255, 0.15)',
                        tension: 0.4, fill: true, pointRadius: 4
                    },
                    {
                        label: 'Baseline Standard Projection (TB)',
                        data: baselineData,
                        borderColor: '#34d399',
                        backgroundColor: 'rgba(52, 211, 153, 0.1)',
                        tension: 0.4, fill: false, pointRadius: 0
                    }
                ]
            };
            if (forecastChart) forecastChart.destroy();
            forecastChart = new Chart(ctx, { type: 'line', data: data, options: { responsive: true, maintainAspectRatio: false, scales: { y: { title: { display: true, text: 'Total Volume (TB)', color: 'var(--var-text-color)' }, grid: { color: 'rgba(255, 255, 255, 0.1)' }, ticks: { color: 'var(--var-text-color)' } }, x: { grid: { display: false }, ticks: { color: 'var(--var-text-color)' } } }, plugins: { legend: { labels: { color: 'var(--var-text-color)' } } } } });
        }

        // 2. Stacked Cost Breakdown Forecast Chart
        function createCostBreakdownChart(canvasId, tier, horizon, initialVolume, accessFrequency, complianceCostPerTB, egressMultiplier) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            const growthRate = initialVolume * 0.005 + 2; 
            const { labels, predictedData } = generateChartData(horizon, initialVolume, false, growthRate); // Use non-anomaly data for cost forecast

            const datasets = {
                storage: [],
                access: [],
                egress: [],
                compliance: []
            };

            predictedData.forEach(volume => {
                const costs = calculateCost(tier, volume, accessFrequency, egressMultiplier);
                datasets.storage.push(costs.storage);
                datasets.access.push(costs.access);
                datasets.egress.push(costs.egress);
                datasets.compliance.push(volume * complianceCostPerTB);
            });
            
            const data = {
                labels: labels,
                datasets: [
                    { label: 'Compliance Overhead ($)', data: datasets.compliance, backgroundColor: '#60a5fa', stack: 'Stack 0' },
                    { label: 'Egress Fees ($)', data: datasets.egress, backgroundColor: '#f87171', stack: 'Stack 0' },
                    { label: 'Access/Ops Fees ($)', data: datasets.access, backgroundColor: '#facc15', stack: 'Stack 0' },
                    { label: 'Storage Fees ($)', data: datasets.storage, backgroundColor: '#00ffff', stack: 'Stack 0' },
                ]
            };
            
            if (costChart) costChart.destroy();
            costChart = new Chart(ctx, { type: 'bar', data: data, options: { responsive: true, maintainAspectRatio: false, scales: { x: { stacked: true, grid: { display: false }, ticks: { color: 'var(--var-text-color)' } }, y: { stacked: true, title: { display: true, text: 'Monthly Cost ($)', color: 'var(--var-text-color)' }, grid: { color: 'rgba(255, 255, 255, 0.1)' }, ticks: { color: 'var(--var-text-color)', callback: (value) => `$${value.toLocaleString()}` } } }, plugins: { legend: { labels: { color: 'var(--var-text-color)' } } } } });
        }

        // 3. 4D Scatter Plot (Cost/Performance Trade-off)
        function createScatterChart(canvasId, costedTiers, finalTier) {
            const ctx = document.getElementById(canvasId).getContext('2d');

            // Data for Chart: { x: Latency Reduction %, y: Monthly Cost }
            const dataPoints = costedTiers.map(tier => ({
                x: tier.baseLatencyReduction, 
                y: tier.optimizedCost,
                r: 10, // Base size
                tierName: tier.name,
                carbonIntensity: tier.carbonIntensity,
                isOptimal: tier.name === finalTier.name
            }));
            
            const data = {
                datasets: [{
                    label: 'Available Tiers',
                    data: dataPoints,
                    backgroundColor: dataPoints.map(p => p.isOptimal ? 'var(--var-accent-color)' : (p.carbonIntensity < 250 ? '#34d399' : '#facc15')),
                    borderColor: dataPoints.map(p => p.isOptimal ? '#fff' : 'rgba(255, 255, 255, 0.5)'),
                    borderWidth: dataPoints.map(p => p.isOptimal ? 4 : 1),
                    pointRadius: dataPoints.map(p => p.isOptimal ? 8 : 6),
                    pointHoverRadius: dataPoints.map(p => p.isOptimal ? 12 : 10),
                }]
            };

            if (scatterChart) scatterChart.destroy();
            scatterChart = new Chart(ctx, {
                type: 'scatter',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            title: { display: true, text: 'Latency Reduction vs Baseline (%)', color: 'var(--var-text-color)' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' },
                            min: 0,
                            max: 100,
                            ticks: { color: 'var(--var-text-color)' }
                        },
                        y: {
                            title: { display: true, text: 'Monthly Cost ($)', color: 'var(--var-text-color)' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' },
                            ticks: { color: 'var(--var-text-color)', callback: (value) => `$${value.toLocaleString()}` }
                        }
                    },
                    plugins: { 
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const p = context.raw;
                                    return `${p.tierName} | Cost: $${p.y.toFixed(0)} | Carbon: ${p.carbonIntensity} g/kWh`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // --- Optimization Logic ---
        function runOptimizationLoop() {
            // Input Validation and Parsing
            const dataVolume = parseFloat(document.getElementById('dataVolume').value);
            const accessFrequency = parseFloat(document.getElementById('accessFrequency').value);
            const forecastHorizon = parseFloat(document.getElementById('forecastHorizon').value);
            const maxBudget = parseFloat(document.getElementById('maxBudget').value);
            const compliancePolicy = document.getElementById('compliancePolicy').value.toUpperCase().trim() || 'NONE';
            const otherImplications = document.getElementById('otherImplications').value.trim();
            const rtoConstraint = parseFloat(document.getElementById('rtoConstraint').value); // RTO in seconds
            const egressMultiplier = parseFloat(document.getElementById('egressMultiplier').value);
            const isAnomalyChecked = document.getElementById('anomalyDetection').checked;

            if (dataVolume <= 0 || accessFrequency < 0 || forecastHorizon <= 0 || maxBudget <= 0 || rtoConstraint <= 0 || isNaN(dataVolume) || isNaN(accessFrequency) || isNaN(forecastHorizon) || isNaN(maxBudget) || isNaN(rtoConstraint)) {
                 document.getElementById('validation-error').textContent = 'ERROR: Please ensure all numeric inputs are valid and positive.';
                 document.getElementById('validation-error').classList.remove('hidden');
                 resultSection.classList.add('hidden');
                 return;
            }
            document.getElementById('validation-error').classList.add('hidden');

            // --- Interactive Loading Sequence ---
            const analysisSteps = [
                'Initializing Neural Fabric and Data Connectors...',
                'Parsing User Constraints (Budget, RTO, Compliance)...',
                'Simulating Data Growth & Access Risk Profile...',
                'Evaluating ' + storageTiers.length + ' Vendor Tiers for Multi-Factor Score...',
                'Applying Weighted Logic and Constraint Filtering...',
                'Finalizing Predictive Policy & Generating XAI Report...'
            ];
            let stepIndex = 0;
            loadingMessage.textContent = analysisSteps[stepIndex];

            runButton.innerHTML = '<span class="animate-pulse">Analyzing...</span>';
            runButton.disabled = true;
            loadingOverlay.classList.remove('hidden');
            resultSection.classList.add('hidden'); // Hide results until done

            const interval = setInterval(() => {
                stepIndex++;
                if (stepIndex < analysisSteps.length) {
                    loadingMessage.textContent = analysisSteps[stepIndex];
                } else {
                    clearInterval(interval);
                    processOptimizationResult(dataVolume, accessFrequency, forecastHorizon, maxBudget, compliancePolicy, otherImplications, rtoConstraint, egressMultiplier, isAnomalyChecked);
                }
            }, 400); // Fast cycle through analysis steps

        }

        function processOptimizationResult(dataVolume, accessFrequency, forecastHorizon, maxBudget, compliancePolicy, otherImplications, rtoConstraint, egressMultiplier, isAnomalyChecked) {
            
            // --- Constraint Filtering ---
            const rtoConstraintMS = rtoConstraint * 1000;
            const acceptableTiers = storageTiers.filter(tier => tier.latencyMS <= rtoConstraintMS);
            let tierList = acceptableTiers.length > 0 ? acceptableTiers : storageTiers; // Fallback to all tiers if RTO is extremely strict

            // --- Costing and Scoring ---
            const tieredList = tierList.map((tier, index) => {
                const costBreakdown = calculateCost(tier, dataVolume, accessFrequency, egressMultiplier);
                let score = 0;
                
                // 1. Cost Score (40%)
                const maxTheoreticalTotalCost = calculateCost(storageTiers[storageTiers.length - 1], dataVolume, accessFrequency, egressMultiplier).total * 1.5; 
                const costNorm = Math.max(0, 1 - (costBreakdown.total / maxTheoreticalTotalCost)); 
                score += costNorm * weights.cost;

                // 2. Performance/Access Score (25%)
                let perfNorm = 0;
                if (accessFrequency < 1) { perfNorm = 1 - (index / tierList.length); // Favors Cold
                } else if (accessFrequency >= 20) { perfNorm = index / tierList.length; // Favors Hot
                } else { perfNorm = 1 - Math.abs(index - 3.0) / 3.0; } // Favors Warm
                
                // Penalize if RTO is near the limit (Stress on performance factor)
                if (tier.latencyMS > rtoConstraintMS * 0.5) score -= 0.1;

                score += perfNorm * weights.performance;

                // 3. Carbon Score (15%)
                const carbonNorm = Math.max(0, 1 - ((tier.carbonIntensity - 150) / (450 - 150)));
                score += carbonNorm * weights.carbon;

                // 4. Compliance Score (20%)
                let compScore = 0;
                if (tier.durability.length > 15) compScore += 0.5;
                if (otherImplications.includes('AWS') && tier.provider === 'AWS') compScore += 0.2;
                if (compliancePolicy.includes('HIPAA') || compliancePolicy.includes('FEDRAMP')) {
                    if (tier.provider === 'AWS' || tier.provider === 'Azure') compScore += 0.5;
                }
                if (compliancePolicy.includes('GDPR') && tier.provider === 'Azure') { compScore += 0.8; }
                score += Math.min(1, compScore) * weights.compliance;

                const complianceCost = dataVolume * 0.50; // Per TB overhead

                return {
                    ...tier,
                    rawCost: costBreakdown.total, 
                    storageCost: costBreakdown.storage,
                    accessCost: costBreakdown.access,
                    egressCost: costBreakdown.egress,
                    complianceOverhead: complianceCost,
                    score: score,
                    baseLatencyReduction: parseFloat(tier.latency.replace('‚âà','').replace('%','')),
                    optimizedCost: costBreakdown.total + complianceCost
                };
            }).sort((a, b) => b.score - a.score); // Sort by highest score first

            
            const optimalTier = tieredList[0];
            let theoreticalTier = { ...optimalTier }; 
            let isAnomalyShift = false;

            // --- Anomaly Detection Override ---
            if (isAnomalyChecked && optimalTier.name.includes("Archive")) {
                const warmTier = tieredList.find(t => t.name.includes("Access") || t.name.includes("Cool") || t.name.includes("Nearline"));
                if (warmTier) {
                    optimalTier = warmTier;
                    isAnomalyShift = true;
                }
            }

            // --- Final Budget Constraint Check ---
            const highEndTier = storageTiers.find(t => t.name === "Standard Storage");
            const baselineCost = calculateCost(highEndTier, dataVolume, accessFrequency, 1.0).total + (dataVolume * 0.50); // Baseline cost includes compliance overhead

            let finalTier = { ...optimalTier };
            let isBudgetExceeded = false;

            if (finalTier.optimizedCost > maxBudget) {
                isBudgetExceeded = true;
                const affordableTiers = tieredList.filter(t => t.optimizedCost <= maxBudget).sort((a, b) => b.score - a.score);
                if (affordableTiers.length > 0) {
                    finalTier = affordableTiers[0];
                } else {
                    finalTier = tieredList[tieredList.length - 1]; // Cheapest possible
                }
            }
            
            // --- 5. Update UI Metrics and Charts ---
            const monthlySavings = ((baselineCost - finalTier.optimizedCost) / baselineCost) * 100;

            // Apply pulse effect to the two most important cards
            cardProvider.classList.add('pulse-active');
            cardSavings.classList.add('pulse-active');

            document.getElementById('optimal-provider').innerHTML = `${finalTier.provider}<br><span class="text-base font-normal text-gray-400">(${finalTier.name})</span>`;
            document.getElementById('projected-savings').textContent = `${Math.max(0, monthlySavings).toFixed(1)}%`;
            document.getElementById('projected-latency').textContent = `${finalTier.latency} (${finalTier.latencyMS < rtoConstraintMS ? 'Pass' : 'Fail'})`;
            document.getElementById('carbon-score').textContent = `${finalTier.carbonIntensity} g/kWh`;

            const inputsForExplanation = { 
                dataVolume, accessFrequency, compliancePolicy, otherImplications, baselineCost, maxBudget, rtoConstraint,
                storageCost: finalTier.storageCost, accessCost: finalTier.accessCost, egressCost: finalTier.egressCost, complianceOverhead: finalTier.complianceOverhead
            };
            
            // Update XAI Explanation
            document.getElementById('xai-explanation').innerHTML = generateExplanation(finalTier, theoreticalTier, inputsForExplanation, isBudgetExceeded, isAnomalyShift, finalTier.score);

            // Update Alerts
            anomalyAlert.innerHTML = `<span class="font-bold text-lg">‚ö†Ô∏è ANOMALY SHIFT:</span> Predictive model detected **${forecastHorizon/2}-month access risk**. Policy auto-shifted to **${finalTier.name}** to prevent retrieval/egress costs.`;
            anomalyAlert.classList.toggle('hidden', !isAnomalyShift);
            
            budgetWarning.innerHTML = `<span class="font-bold text-lg">üí∞ BUDGET OVERRIDE:</span> Theoretical optimal cost ($${theoreticalTier.optimizedCost.toFixed(2)}/mo) exceeded the $${maxBudget.toFixed(2)} budget. Downgraded to **${finalTier.name}**.`;
            budgetWarning.classList.toggle('hidden', !isBudgetExceeded);

            // Update Charts
            createForecastChart('storage-forecast-graph', forecastHorizon, dataVolume, isAnomalyChecked);
            createCostBreakdownChart('cost-breakdown-chart', finalTier, forecastHorizon, dataVolume, accessFrequency, finalTier.complianceOverhead / dataVolume, egressMultiplier);
            createScatterChart('scatter-chart', tieredList, finalTier);


            // Show results and reset button with animation
            loadingOverlay.classList.add('hidden');
            resultSection.classList.remove('hidden');
            resultSection.classList.add('slide-up-active');

            runButton.innerHTML = '<svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>Run AI Optimization';
            runButton.disabled = false;
            resultSection.scrollIntoView({ behavior: 'smooth' });

        }

        // --- Event Handlers & Initialization ---

        function updateWeightsFromSliders() {
            const cost = parseInt(document.getElementById('weightCost').value);
            const performance = parseInt(document.getElementById('weightPerformance').value);
            const carbon = parseInt(document.getElementById('weightCarbon').value);
            const compliance = parseInt(document.getElementById('weightCompliance').value);

            // Logic to ensure sum is 100% (distributes difference) - simplified
            let total = cost + performance + carbon + compliance;
            const diff = 100 - total;

            // Prioritize cost/performance/compliance for adjustment
            let newCost = cost;
            let newPerformance = performance;
            let newCarbon = carbon;
            let newCompliance = compliance;

            if (diff !== 0) {
                // For simplicity in this demo, we'll force the last slider (Compliance) to absorb the difference.
                newCompliance = Math.max(5, compliance + diff);
                
                // If compliance is maxed (95) and we still have a huge diff (unlikely with step 5), we cap it.
                if (newCompliance > 95) newCompliance = 95;
                if (newCompliance < 5) newCompliance = 5;

                // Re-read to handle min/max constraint
                total = cost + performance + carbon + newCompliance;
                
                // Final normalization (optional, for safety)
                if (total !== 100) {
                   const normalizeFactor = 100 / total;
                   newCost = Math.round(cost * normalizeFactor);
                   newPerformance = Math.round(performance * normalizeFactor);
                   newCarbon = Math.round(carbon * normalizeFactor);
                   newCompliance = Math.round(newCompliance * normalizeFactor);
                }
            }
            
            weights.cost = newCost / 100;
            weights.performance = newPerformance / 100;
            weights.carbon = newCarbon / 100;
            weights.compliance = newCompliance / 100;

            document.getElementById('costValue').textContent = newCost;
            document.getElementById('performanceValue').textContent = newPerformance;
            document.getElementById('carbonValue').textContent = newCarbon;
            document.getElementById('complianceValue').textContent = newCompliance;
            document.getElementById('weightCompliance').value = newCompliance;
            
            // Update Egress Multiplier display
            egressMultiplierDisplay.textContent = `${egressMultiplierInput.value}x`;
            
            // To provide real-time feedback, re-run the optimization silently (optional, but cool)
            // runOptimizationLoop(); 
        }

        document.getElementById('weightSliders').querySelectorAll('input[type="range"]').forEach(slider => {
            slider.addEventListener('input', updateWeightsFromSliders);
        });
        egressMultiplierInput.addEventListener('input', updateWeightsFromSliders);

        const facts = [
            "The largest hidden cost in multi-cloud is often **Data Egress**, which can cost 5-10 times more than storing the data itself.",
            "Carbon-aware optimization favors regions with high renewable energy usage, such as Azure in the Netherlands or GCP in Iowa.",
            "Achieving high percentage cost savings is typically done by moving infrequently accessed data from Hot to Archive tiers.",
            "High durability (99.999999999%) means losing one object in $10^{11}$ stored, a measure that exceeds human comprehension.",
            "RTO (Recovery Time Objective) constraints on the cloud often immediately disqualify the cheapest Archive tiers."
        ];

        function setFactOfTheDay() {
            const randomIndex = Math.floor(Math.random() * facts.length);
            document.getElementById('fact-of-the-day').textContent = facts[randomIndex];
        }

        window.onload = () => {
             setFactOfTheDay();
             updateWeightsFromSliders(); // Initial update of weights
             runOptimizationLoop(); // Initial run to set the default state
        };

        runButton.addEventListener('click', () => {
            // Remove pulse and slide-up class before running again
            cardProvider.classList.remove('pulse-active');
            cardSavings.classList.remove('pulse-active');
            resultSection.classList.remove('slide-up-active');
            runOptimizationLoop();
        });

    </script>
</body>
</html>